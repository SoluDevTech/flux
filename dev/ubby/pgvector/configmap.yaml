apiVersion: v1
kind: ConfigMap
metadata:
  name: pgvector-init
  namespace: ubby
data:
  init.sql: |
    CREATE TABLE IF NOT EXISTS "projects" (
      "id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
      "name" TEXT,
      "nodes" JSONB,
      "edges" JSONB,
      "user_id" TEXT,
      "description" TEXT,
      "created_at" BIGINT,
      "version" TEXT,
      PRIMARY KEY("id")
    );


    CREATE TABLE IF NOT EXISTS "users" (
      "id" TEXT NOT NULL UNIQUE,
      "created_at" BIGINT,
      PRIMARY KEY("id")
    );


    CREATE TABLE IF NOT EXISTS "users_projects" (
      "user_project_pk" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
      "user_id" TEXT,
      "project_id" INTEGER,
      PRIMARY KEY("user_project_pk"),
      CONSTRAINT "uq_user_project" UNIQUE ("user_id", "project_id")
    );


    CREATE TABLE IF NOT EXISTS "mcp_servers" (
      "id" INTEGER NOT NULL UNIQUE GENERATED BY DEFAULT AS IDENTITY,
      "configuration" JSONB,
      "project_id" INTEGER,
      PRIMARY KEY("id")
    );

    CREATE TABLE IF NOT EXISTS "openapis" (
      "uuid" TEXT NOT NULL UNIQUE,
      "schema" JSONB,
      PRIMARY KEY("uuid")
    );


    ALTER TABLE "users_projects"
    ADD FOREIGN KEY("user_id") REFERENCES "users"("id")
    ON UPDATE NO ACTION ON DELETE NO ACTION;
    ALTER TABLE "users_projects"
    ADD FOREIGN KEY("project_id") REFERENCES "projects"("id")
    ON UPDATE NO ACTION ON DELETE NO ACTION;
    ALTER TABLE "mcp_servers"
    ADD FOREIGN KEY("project_id") REFERENCES "projects"("id")
    ON UPDATE NO ACTION ON DELETE NO ACTION;

    CREATE INDEX "users_index_0"
    ON "users" ("id");

    CREATE INDEX "projects_index_0"
    ON "projects" ("id");

    CREATE INDEX "users_projects_index_1"
    ON "users_projects" ("user_id");

    CREATE INDEX "users_projects_index_2"
    ON "users_projects" ("project_id");

    CREATE INDEX "mcp_servers_index_1"
    ON "mcp_servers" ("project_id");

    CREATE INDEX "mcp_servers_index_0"
    ON "mcp_servers" ("id");